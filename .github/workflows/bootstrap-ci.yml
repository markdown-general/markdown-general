name: bootstrap
on: [push, pull_request]

concurrency:
  group: bootstrap-${{ github.ref }}
  cancel-in-progress: true

jobs:
  bootstrap:
    name: Bootstrap with GHC 9.12
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up GHC 9.12
        uses: haskell-actions/setup@v2
        id: setup
        with:
          ghc-version: '9.12'

      - name: Restore cached dependencies
        uses: actions/cache/restore@v4
        id: cache
        env:
          key: ${{ runner.os }}-ghc-${{ steps.setup.outputs.ghc-version }}-cabal-${{ steps.setup.outputs.cabal-version }}
        with:
          path: ${{ steps.setup.outputs.cabal-store }}
          key: ${{ env.key }}-bootstrap
          restore-keys: ${{ env.key }}-

      - name: Install markdown-unlit
        run: cabal install markdown-unlit --installdir=$HOME/.local/bin --overwrite-policy=always

      - name: Add .local/bin to PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Verify markdown-unlit
        run: markdown-unlit --help

      - name: Install perf library
        run: cabal install perf --lib --package-env .

      - name: Extract bootstrap script
        run: |
          sed -n '/^```bash$/,/^```$/p' zone/tools/haskell-build-bootstrap.md | sed '1d;$d' > /tmp/bootstrap.sh
          chmod +x /tmp/bootstrap.sh

      - name: Run bootstrap
        run: bash /tmp/bootstrap.sh

      - name: Verify executables exist
        run: |
          ls -la artifacts/bin/
          test -f artifacts/bin/discover-executables
          test -f artifacts/bin/haskell-api
          test -x artifacts/bin/discover-executables
          test -x artifacts/bin/haskell-api

      - name: Verify executables run
        run: |
          artifacts/bin/discover-executables --help || echo "discover-executables doesn't have --help"
          artifacts/bin/haskell-api --help || true

      - name: Verify cabal file
        run: |
          cat artifacts/haskell-build/haskell-build.cabal
          grep "executable discover-executables" artifacts/haskell-build/haskell-build.cabal
          grep "executable haskell-api" artifacts/haskell-build/haskell-build.cabal

      - name: Test card installation (cache)
        run: |
          export PATH=$PWD/artifacts/bin:$PATH
          haskell-api install zone/tools/cache.md

      - name: Verify cache installed
        run: |
          test -f artifacts/bin/cache
          test -x artifacts/bin/cache

      - name: Test cache round-trip
        run: |
          export PATH=$PWD/artifacts/bin:$PATH
          mkdir -p /tmp/test-cache-ci
          echo "# Test file" > /tmp/test-cache-ci/test.md
          cache flatten --dir /tmp/test-cache-ci --output /tmp/test-cache.md
          mkdir -p /tmp/restored
          cache split /tmp/test-cache.md --output-dir /tmp/restored
          diff -r /tmp/test-cache-ci /tmp/restored/test-cache-ci

      - name: Save cached dependencies
        uses: actions/cache/save@v4
        if: steps.cache.outputs.cache-hit != 'true'
        with:
          path: ${{ steps.setup.outputs.cabal-store }}
          key: ${{ steps.cache.outputs.cache-primary-key }}

      - name: Bootstrap summary
        run: |
          echo "✓ Bootstrap successful"
          echo "✓ discover-executables: $(artifacts/bin/discover-executables 2>&1 | head -1 || echo 'installed')"
          echo "✓ haskell-api: installed"
          echo "✓ cache: $(artifacts/bin/cache flatten --help | head -1 || echo 'installed')"
