# haskell-build-bootstrap.md

Two-phase bootstrap for the Haskell build system.

Phase 1: Build discover-executables (cabal file generator)
Phase 2: Build haskell-api (universal card processor)

## what it does

Bootstraps the Haskell toolchain in correct dependency order:
- artifacts/haskell-build/ directory
- discover-executables (generates haskell-build.cabal from directory contents)
- haskell-api (installs other cards)
- Both executables installed to artifacts/bin/

## why two phases

**Dependency order** ⟜ haskell-api needs discover-executables, so build it first
**Automated cabal** ⟜ discover-executables generates cabal from directory contents
**No manual edits** ⟜ cabal file is derived artifact, regenerated on every install/uninstall

## extraction

To extract and run the bootstrap script:

```bash
# Extract script from this markdown file
sed -n '/^```bash$/,/^```$/p' ~/markdown-general/zone/tools/haskell-build-bootstrap.md | sed '1d;$d' > /tmp/bootstrap.sh

# Run it from sisyphus directory
cd ~/markdown-general
bash /tmp/bootstrap.sh
```

Or copy/paste the script directly from the run section below.

## run

Save and execute this script from ~/markdown-general:

```bash
#!/bin/bash
# Bootstrap script for markdown-general haskell-build system
# Run from ~/markdown-general directory

set -e  # Exit on any error

echo "=== markdown-general Haskell Build Bootstrap ==="
echo

# Ensure we're in markdown-general directory
if [ ! -d "zone/tools" ]; then
    echo "ERROR: Run this from ~/markdown-general directory"
    exit 1
fi

# Create build directory
echo "Creating build directories..."
mkdir -p artifacts/haskell-build
mkdir -p artifacts/bin

cd artifacts/haskell-build

# Phase 1: Bootstrap discover-executables
echo
echo "Phase 1: Bootstrapping discover-executables..."
markdown-unlit main -h ../../zone/tools/discover-executables.md \
  ../../zone/tools/discover-executables.md discover-executables.hs

# Create minimal cabal file with just discover-executables
cat > haskell-build.cabal << 'EOF'
cabal-version: 2.4
name: haskell-build
version: 0.1.0.0
build-type: Simple

executable discover-executables
  main-is: discover-executables.hs
  build-depends: base, directory, filepath
  ghc-options: -Wall
  default-language: Haskell2010
EOF

echo "Building discover-executables..."
if ! cabal build discover-executables; then
    echo "ERROR: discover-executables build failed"
    exit 1
fi

echo "Installing discover-executables..."
if ! cabal install discover-executables --installdir=../bin --overwrite-policy=always; then
    echo "ERROR: discover-executables install failed"
    exit 1
fi

# Phase 2: Bootstrap haskell-api
echo
echo "Phase 2: Bootstrapping haskell-api..."
markdown-unlit main -h ../../zone/tools/haskell-api.md \
  ../../zone/tools/haskell-api.md haskell-api.hs

# Regenerate cabal file using discover-executables
echo "Regenerating cabal file..."
if ! ../bin/discover-executables; then
    echo "ERROR: cabal regeneration failed"
    exit 1
fi

echo "Building haskell-api..."
if ! cabal build haskell-api; then
    echo "ERROR: haskell-api build failed"
    exit 1
fi

echo "Installing haskell-api..."
if ! cabal install haskell-api --installdir=../bin --overwrite-policy=always; then
    echo "ERROR: haskell-api install failed"
    exit 1
fi

cd ../..

echo
echo "✓ Bootstrap complete!"
echo
echo "Installed executables:"
ls -la artifacts/bin/
echo
echo "Add to PATH:"
echo "  export PATH=\$HOME/markdown-general/artifacts/bin:\$PATH"
echo
echo "Or in your current session:"
echo "  export PATH=$PWD/artifacts/bin:\$PATH"
echo
echo "Then use haskell-api to install other cards:"
echo "  haskell-api install zone/tools/cache.md"
echo
```

## structure

**Phase 1 cabal** (just discover-executables):

```cabal
cabal-version: 2.4
name: haskell-build
version: 0.1.0.0
build-type: Simple

executable discover-executables
  main-is: discover-executables.hs
  build-depends: base, directory, filepath
  ghc-options: -Wall
  default-language: Haskell2010
```

**Phase 2 cabal** (regenerated by discover-executables):

```cabal
cabal-version: 2.4
name: haskell-build
version: 0
build-type: Simple

executable discover-executables
  main-is: discover-executables.hs
  build-depends: base, text, optparse-applicative, directory, filepath, process, perf, clock, containers
  ghc-options: -Wall
  default-language: Haskell2010

executable haskell-api
  main-is: haskell-api.hs
  build-depends: base, text, optparse-applicative, directory, filepath, process, perf, clock, containers
  ghc-options: -Wall
  default-language: Haskell2010
```

**After haskell-api install** (adds more executables):

discover-executables regenerates cabal to include newly installed cards.

## verification

After running bootstrap:

```bash
ls -la ~/markdown-general/artifacts/bin/
cat ~/markdown-general/artifacts/haskell-build/haskell-build.cabal
```

Expected:
- artifacts/bin/discover-executables exists and is executable
- artifacts/bin/haskell-api exists and is executable
- haskell-build.cabal contains both executables
- Both have full dependency lists (base, text, optparse-applicative, directory, filepath, process, perf, clock, containers)

## next steps

After bootstrap, you can install other cards:

1. Add artifacts/bin to PATH:
```bash
export PATH=$HOME/markdown-general/artifacts/bin:$PATH
```

2. Install a card:
```bash
haskell-api install zone/tools/cache.md
```

3. Verify it was added:
```bash
ls artifacts/bin/cache
cat artifacts/haskell-build/haskell-build.cabal | grep "executable cache"
```

4. Test the card:
```bash
haskell-api test zone/tools/cache.md
```
